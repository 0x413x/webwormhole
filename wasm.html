<html>
	<head>
		<meta charset="utf-8"/>
		<script src="wasm_exec.js"></script>
		<script>
			const go = new Go();
			WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject).then((result) => {
				go.run(result.instance);
			});
		</script>
	</head>
	<body></body>

<script>
let dial = async (slot, config) => {
	let pc = new RTCPeerConnection(config);

	dc = pc.createDataChannel("game", {negotiated: true, id: 1});
	dc.onmessage = handlemsg;
	dc.onopen = handleconnect;
	dc.onclose = handleclose;

	await pc.setLocalDescription(await pc.createOffer())
	await new Promise(r=>{pc.onicecandidate=e=>{if(e.candidate === null){r()}}})
	let response = await fetch(`https://minimumsignal.0f.io/${slot}`, {
		method: 'PUT',
		body: JSON.stringify(pc.localDescription)
	})
	if (response.status === 200) {
		await pc.setRemoteDescription(new RTCSessionDescription(await response.json()));
	} else if (response.status === 428) {
		// precondition failed
		pc = new RTCPeerConnection(config);
		dc = pc.createDataChannel("game", {negotiated: true, id: 1});
		dc.onmessage = handlemsg;
		dc.onopen = handleconnect;
		dc.onclose = handleclose;
		//await pc.setLocalDescription({type: "rollback"});
		await pc.setRemoteDescription(new RTCSessionDescription(await response.json()));
		await pc.setLocalDescription(await pc.createAnswer());
		await new Promise(r=>{pc.onicecandidate=e=>{if(e.candidate === null){r()}}})
		await fetch(`https://minimumsignal.0f.io/${slot}`, {
			method: 'DELETE',
			body: JSON.stringify(pc.localDescription),
			headers: {
				'If-Match': response.headers.get('ETag')
			}
		});
	}
	return dc
}
</script>
</html>
